<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Ben Wong,wenbinben@gmail.com"><title>iOS 实时计步功能的简单实现 · 阿飞的小蝴蝶</title><meta name="description" content="写作背景  今天就和大家聊一聊iOS中计步功能的实现。为什么会突然想到实现这个功能呢？，哎，都是泪呀。 之前面试期间有家公司就是做计步功能的。问我如何实现？然而在我印象中直接调用HealthKit框架获取苹果的健康应用数据不就行了。。。然后Boss说这样非常容易作弊。请戳我,固然没有修改成功，那是微"><meta name="keywords" content="Hexo,HTML,Ben,CSS,安卓,android,Linux,linuxdeepin"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">阿飞的小蝴蝶</a></h3><div class="description"><p>Nothing lasts forever.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/Ben_wenbin"><i class="fa fa-twitter"></i></a></li><li><a href="http://instagram.com/hwbinbenben"><i class="fa fa-instagram"></i></a></li><li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li><li><a href="http://weibo.com/ben0036"><i class="fa fa-weibo"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="https://secure.gravatar.com/avatar/e71df8021446fe9759a9928b1dd5c28d?s=180&amp;r=G&amp;d="></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>iOS 实时计步功能的简单实现</a></h3></div><div class="post-content"><h1 id="写作背景"><a href="#写作背景" class="headerlink" title="写作背景"></a>写作背景</h1><p>  今天就和大家聊一聊iOS中计步功能的实现。为什么会突然想到实现这个功能呢？，哎，都是泪呀。 之前面试期间有家公司就是做计步功能的。问我如何实现？然而在我印象中直接调用<code>HealthKit</code>框架获取苹果的健康应用数据不就行了。。。<br>然后Boss说这样非常容易作弊。<a href="http://www.jianshu.com/p/b8b7fd5447c2" target="_blank" rel="external">请戳我,固然没有修改成功，那是微信团队有这样的技术实力，去判断数据来源</a>  所以不打算采用这样的方式。<br>于是乎，话音刚落。就被Boss反问一句:“那如果不让你用<code>HealthKit</code>框架呢？”<br>我：“啊，这样啊。。。我也不知道”<br>Boss:“……(此处你们懂得)”</p>
<h5 id="首先iOS中的计步功能，比较普遍的应该有两种方式："><a href="#首先iOS中的计步功能，比较普遍的应该有两种方式：" class="headerlink" title="首先iOS中的计步功能，比较普遍的应该有两种方式："></a>首先iOS中的计步功能，比较普遍的应该有两种方式：</h5><h4 id="No-1"><a href="#No-1" class="headerlink" title="No.1"></a>No.1</h4><p>非常直接了当一种方式，直接调用系统的健康数据，基于<code>HealthKit</code>框架的，但是貌似是一小时更新一次数据。如果要实时获取步数，这种方式并不是最佳。<br><a href="http://www.jianshu.com/p/42e913588380" target="_blank" rel="external">这种例子已经有很多了。就不再贴此代码了。</a></p>
<h4 id="No-2"><a href="#No-2" class="headerlink" title="No.2"></a>No.2</h4><p> 基于<code>CoreMotion</code>框架，本人也是才疏学浅，了解的并不多。<a href="http://www.jianshu.com/p/50aa5dbc6d16" target="_blank" rel="external">大家可以看下这个框架中一些常见的其他应用场景</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> 运动传感器\加速度传感器\加速计（Motion/Accelerometer Sensor）</div><div class="line"> 最早出现在iOS设备上的传感器之一</div><div class="line"> 加速计用于检测设备在X、Y、Z轴上的加速度 （哪个方向有力的作用）</div><div class="line"> 加速计可以用于检测设备的摇晃，经典应用场景</div><div class="line">* 摇一摇</div><div class="line">* 计步器</div></pre></td></tr></table></figure>
<p><a href="http://www.cnblogs.com/dongwenbo/p/4301530.html" target="_blank" rel="external">如果有对传感器很陌生，想要普及下的童鞋，该链接会帮到你</a></p>
<p> 传感器的类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">运动传感器\加速度传感器\加速计（Motion/Accelerometer Sensor）</div><div class="line">环境光传感器（Ambient Light Sensor）</div><div class="line">距离传感器（Proximity Sensor）</div><div class="line">磁力计传感器（Magnetometer Sensor）</div><div class="line">内部温度传感器（Internal Temperature Sensor）</div><div class="line">湿度传感器（Moisture Sensor）</div><div class="line">陀螺仪（Gyroscope）</div></pre></td></tr></table></figure></p>
<p>下面是实现代码，因为要实时计步，就写成了单例</p>
<p>StepManager.h<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">@interface StepManager : NSObject</div><div class="line"></div><div class="line"></div><div class="line">@property (nonatomic) NSInteger step;                       // 运动步数（总计）</div><div class="line"></div><div class="line">+ (StepManager *)sharedManager;</div><div class="line"></div><div class="line"></div><div class="line">//开始计步</div><div class="line">- (void)startWithStep;</div><div class="line"></div><div class="line">//得到计步所消耗的卡路里</div><div class="line">//+ (NSInteger)getStepCalorie;</div><div class="line">//</div><div class="line">//得到所走的路程(单位:米)</div><div class="line">//+ (CGFloat)getStepDistance;</div><div class="line">//</div><div class="line">//得到运动所用的时间</div><div class="line">//+ (NSInteger)getStepTime;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>StepManager.m<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div></pre></td><td class="code"><pre><div class="line">#import &quot;StepManager.h&quot;</div><div class="line">#import &quot;StepModel.h&quot;</div><div class="line">#import &lt;CoreMotion/CoreMotion.h&gt;</div><div class="line"></div><div class="line">// 计步器开始计步时间（秒）</div><div class="line">#define ACCELERO_START_TIME 2</div><div class="line"></div><div class="line">// 计步器开始计步步数（步）</div><div class="line">#define ACCELERO_START_STEP 100</div><div class="line"></div><div class="line">// 数据库存储步数采集间隔（步）</div><div class="line">#define DB_STEP_INTERVAL 1</div><div class="line"></div><div class="line"></div><div class="line">@interface StepManager ()</div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line"></div><div class="line">NSMutableArray *arrAll;                 // 加速度传感器采集的原始数组</div><div class="line">int record_no_save;</div><div class="line">int record_no;</div><div class="line">NSDate *lastDate;</div><div class="line"></div><div class="line">&#125;</div><div class="line">@property (nonatomic) NSInteger startStep;                          // 计步器开始步数</div><div class="line"></div><div class="line">@property (nonatomic, retain) NSMutableArray *arrSteps;         // 步数数组</div><div class="line">@property (nonatomic, retain) NSMutableArray *arrStepsSave;     // 数据库纪录步数数组</div><div class="line"></div><div class="line">@property (nonatomic) CGFloat gpsDistance;                  // GPS轨迹的移动距离（总计）</div><div class="line">@property (nonatomic) CGFloat agoGpsDistance;               // GPS轨迹的移动距离（之前）</div><div class="line">@property (nonatomic) CGFloat agoActionDistance;            // 实际运动的移动距离（之前）</div><div class="line"></div><div class="line">@property (nonatomic, retain) NSString *actionId;           // 运动识别ID</div><div class="line">@property (nonatomic) CGFloat distance;                     // 运动里程（总计）</div><div class="line">@property (nonatomic) NSInteger calorie;                    // 消耗卡路里（总计）</div><div class="line">@property (nonatomic) NSInteger second;                     // 运动用时（总计）</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation StepManager</div><div class="line"></div><div class="line">static StepManager *sharedManager;</div><div class="line">static CMMotionManager *motionManager;</div><div class="line"></div><div class="line">+ (StepManager *)sharedManager</div><div class="line">&#123;</div><div class="line">@synchronized (self) &#123;</div><div class="line">if (!sharedManager) &#123;</div><div class="line">sharedManager = [[StepManager alloc]init];</div><div class="line">motionManager = [[CMMotionManager alloc]init];</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">return sharedManager;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//开始计步</div><div class="line">- (void)startWithStep</div><div class="line">&#123;</div><div class="line">if (!motionManager.isAccelerometerAvailable) &#123;</div><div class="line">NSLog(@&quot;加速度传感器不可用&quot;);</div><div class="line">return;</div><div class="line">&#125;else &#123;</div><div class="line"></div><div class="line">motionManager.accelerometerUpdateInterval = 1.0/40;</div><div class="line">&#125;</div><div class="line">[self startAccelerometer];</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)startAccelerometer</div><div class="line">&#123;</div><div class="line">/*  @try 。。。@catch 。。。</div><div class="line">*  @try 后面跟或许会出现异常的程序，代码块</div><div class="line">*  @catch  当@try抛出异常时 系统会进行异常捕捉  具体可以了解下 NSException 异常类     @catch 在这里处理 程序所抛出的异常</div><div class="line">*/</div><div class="line"></div><div class="line">@try  </div><div class="line">&#123;</div><div class="line">//如果不支持陀螺仪,需要用加速传感器来采集数据</div><div class="line">if (!motionManager.isAccelerometerActive) &#123;//  isAccelerometerAvailable方法用来查看加速度器的状态：是否Active（启动）。</div><div class="line"></div><div class="line">// 加速度传感器采集的原始数组</div><div class="line">if (arrAll == nil) &#123;</div><div class="line">arrAll = [[NSMutableArray alloc] init];</div><div class="line">&#125;</div><div class="line">else &#123;</div><div class="line">[arrAll removeAllObjects];</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*</div><div class="line">1.push方式</div><div class="line">这种方式，是实时获取到Accelerometer的数据，并且用相应的队列来显示。即主动获取加速计的数据。</div><div class="line">*/</div><div class="line">NSOperationQueue *queue = [[NSOperationQueue alloc] init];</div><div class="line"></div><div class="line">[motionManager startAccelerometerUpdatesToQueue:queue withHandler:^(CMAccelerometerData *accelerometerData, NSError *error)&#123;</div><div class="line"></div><div class="line">if (!motionManager.isAccelerometerActive) &#123;</div><div class="line">return;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//三个方向加速度值</div><div class="line">double x = accelerometerData.acceleration.x;</div><div class="line">double y = accelerometerData.acceleration.y;</div><div class="line">double z = accelerometerData.acceleration.z;</div><div class="line">//g是一个double值 ,根据它的大小来判断是否计为1步.</div><div class="line">double g = sqrt(pow(x, 2) + pow(y, 2) + pow(z, 2)) - 1;</div><div class="line"></div><div class="line">//将信息保存在步数模型中</div><div class="line">StepModel *stepsAll = [[StepModel alloc] init];</div><div class="line"></div><div class="line">stepsAll.date = [NSDate date];</div><div class="line"></div><div class="line">//日期</div><div class="line">NSDateFormatter *df = [[NSDateFormatter alloc] init] ;</div><div class="line">df.dateFormat  = @&quot;yyyy-MM-dd HH:mm:ss&quot;;</div><div class="line">NSString *strYmd = [df stringFromDate:stepsAll.date];</div><div class="line">df = nil;</div><div class="line">stepsAll.record_time =strYmd;</div><div class="line"></div><div class="line">stepsAll.g = g;</div><div class="line">// 加速度传感器采集的原始数组</div><div class="line">[arrAll addObject:stepsAll];</div><div class="line"></div><div class="line">// 每采集10条，大约1.2秒的数据时，进行分析</div><div class="line">if (arrAll.count == 10) &#123;</div><div class="line"></div><div class="line">// 步数缓存数组</div><div class="line">NSMutableArray *arrBuffer = [[NSMutableArray alloc] init];</div><div class="line"></div><div class="line">arrBuffer = [arrAll copy];</div><div class="line">[arrAll removeAllObjects];</div><div class="line"></div><div class="line">// 踩点数组</div><div class="line">NSMutableArray *arrCaiDian = [[NSMutableArray alloc] init];</div><div class="line"></div><div class="line">//遍历步数缓存数组</div><div class="line">for (int i = 1; i &lt; arrBuffer.count - 2; i++) &#123;</div><div class="line">//如果数组个数大于3,继续,否则跳出循环,用连续的三个点,要判断其振幅是否一样,如果一样,然并卵</div><div class="line">if (![arrBuffer objectAtIndex:i-1] || ![arrBuffer objectAtIndex:i] || ![arrBuffer objectAtIndex:i+1])</div><div class="line">&#123;</div><div class="line">continue;</div><div class="line">&#125;</div><div class="line">StepModel *bufferPrevious = (StepModel *)[arrBuffer objectAtIndex:i-1];</div><div class="line">StepModel *bufferCurrent = (StepModel *)[arrBuffer objectAtIndex:i];</div><div class="line">StepModel *bufferNext = (StepModel *)[arrBuffer objectAtIndex:i+1];</div><div class="line">//控制震动幅度,,,,,,根据震动幅度让其加入踩点数组,</div><div class="line">if (bufferCurrent.g &lt; -0.12 &amp;&amp; bufferCurrent.g &lt; bufferPrevious.g &amp;&amp; bufferCurrent.g &lt; bufferNext.g) &#123;</div><div class="line">[arrCaiDian addObject:bufferCurrent];</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//如果没有步数数组,初始化</div><div class="line">if (nil == self.arrSteps) &#123;</div><div class="line">self.arrSteps = [[NSMutableArray alloc] init];</div><div class="line">self.arrStepsSave = [[NSMutableArray alloc] init];</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 踩点过滤</div><div class="line">for (int j = 0; j &lt; arrCaiDian.count; j++) &#123;</div><div class="line">StepModel *caidianCurrent = (StepModel *)[arrCaiDian objectAtIndex:j];</div><div class="line"></div><div class="line">//如果之前的步数为0,则重新开始记录</div><div class="line">if (self.arrSteps.count == 0) &#123;</div><div class="line">//上次记录的时间</div><div class="line">lastDate = caidianCurrent.date;</div><div class="line"></div><div class="line">// 重新开始时，纪录No初始化</div><div class="line">record_no = 1;</div><div class="line">record_no_save = 1;</div><div class="line"></div><div class="line">// 运动识别号</div><div class="line">NSTimeInterval interval = [caidianCurrent.date timeIntervalSince1970];</div><div class="line">NSNumber *numInter = [[NSNumber alloc] initWithDouble:interval*1000];</div><div class="line">long long llInter = numInter.longLongValue;</div><div class="line">//运动识别id</div><div class="line">self.actionId = [NSString stringWithFormat:@&quot;%lld&quot;,llInter];</div><div class="line"></div><div class="line">self.distance = 0.00f;</div><div class="line">self.second = 0;</div><div class="line">self.calorie = 0;</div><div class="line">self.step = 0;</div><div class="line"></div><div class="line">self.gpsDistance = 0.00f;</div><div class="line">self.agoGpsDistance = 0.00f;</div><div class="line">self.agoActionDistance = 0.00f;</div><div class="line"></div><div class="line">caidianCurrent.record_no = record_no;</div><div class="line">caidianCurrent.step = (int)self.step;</div><div class="line"></div><div class="line">[self.arrSteps addObject:caidianCurrent];</div><div class="line">[self.arrStepsSave addObject:caidianCurrent];</div><div class="line"></div><div class="line">&#125;</div><div class="line">else &#123;</div><div class="line"></div><div class="line">int intervalCaidian = [caidianCurrent.date timeIntervalSinceDate:lastDate] * 1000;</div><div class="line"></div><div class="line">// 步行最大每秒2.5步，跑步最大每秒3.5步，超过此范围，数据有可能丢失</div><div class="line">int min = 259;</div><div class="line">if (intervalCaidian &gt;= min) &#123;</div><div class="line"></div><div class="line">if (motionManager.isAccelerometerActive) &#123;</div><div class="line"></div><div class="line">//存一下时间</div><div class="line">lastDate = caidianCurrent.date;</div><div class="line"></div><div class="line">if (intervalCaidian &gt;= ACCELERO_START_TIME * 1000) &#123;// 计步器开始计步时间（秒)</div><div class="line">self.startStep = 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">if (self.startStep &lt; ACCELERO_START_STEP) &#123;//计步器开始计步步数 (步)</div><div class="line"></div><div class="line">self.startStep ++;</div><div class="line">break;</div><div class="line">&#125;</div><div class="line">else if (self.startStep == ACCELERO_START_STEP) &#123;</div><div class="line">self.startStep ++;</div><div class="line">// 计步器开始步数</div><div class="line">// 运动步数（总计）</div><div class="line">self.step = self.step + self.startStep;</div><div class="line">&#125;</div><div class="line">else &#123;</div><div class="line">self.step ++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">//步数在这里</div><div class="line">NSLog(@&quot;步数%ld&quot;,self.step);</div><div class="line"></div><div class="line">int intervalMillSecond = [caidianCurrent.date timeIntervalSinceDate:[[self.arrSteps lastObject] date]] * 1000;</div><div class="line">if (intervalMillSecond &gt;= 1000) &#123;</div><div class="line"></div><div class="line">record_no++;</div><div class="line"></div><div class="line">caidianCurrent.record_no = record_no;</div><div class="line"></div><div class="line">caidianCurrent.step = (int)self.step;</div><div class="line">[self.arrSteps addObject:caidianCurrent];</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 每隔100步保存一条数据（将来插入DB用）</div><div class="line">StepModel *arrStepsSaveVHSSteps = (StepModel *)[self.arrStepsSave lastObject];</div><div class="line">int intervalStep = caidianCurrent.step - arrStepsSaveVHSSteps.step;</div><div class="line"></div><div class="line">// DB_STEP_INTERVAL 数据库存储步数采集间隔（步） 100步</div><div class="line">if (self.arrStepsSave.count == 1 || intervalStep &gt;= DB_STEP_INTERVAL) &#123;</div><div class="line">//保存次数</div><div class="line">record_no_save++;</div><div class="line">caidianCurrent.record_no = record_no_save;</div><div class="line">[self.arrStepsSave addObject:caidianCurrent];</div><div class="line"></div><div class="line">NSLog(@&quot;---***%ld&quot;,self.step);</div><div class="line">// 备份当前运动数据至文件中，以备APP异常退出时数据也不会丢失</div><div class="line">// [self bkRunningData];</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 运动提醒检查</div><div class="line">// [self checkActionAlarm];</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;];</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;@catch (NSException * e) &#123;</div><div class="line">NSLog(@&quot;Exception: %@&quot;, e);</div><div class="line">return;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">////得到所走的路程(单位:米)</div><div class="line">//+ (CGFloat)getStepDistance</div><div class="line">//&#123;</div><div class="line">//    </div><div class="line">//&#125;</div><div class="line">//</div><div class="line">////得到运动所用的时间</div><div class="line">//+ (NSInteger)getStepTime</div><div class="line">//&#123;</div><div class="line">//    </div><div class="line">//&#125;</div></pre></td></tr></table></figure></p>
<p>其次是外部调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">#import &quot;ViewController.h&quot;</div><div class="line">#import &quot;StepManager.h&quot;</div><div class="line">@interface ViewController ()</div><div class="line">&#123;</div><div class="line">NSTimer *_timer;</div><div class="line">UILabel *lable;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">[super viewDidLoad];</div><div class="line">[[StepManager sharedManager] startWithStep];</div><div class="line">lable =[[ UILabel alloc]initWithFrame:CGRectMake(100, 300, 300, 40)];</div><div class="line"></div><div class="line"></div><div class="line">[self.view addSubview:lable];</div><div class="line">_timer = [NSTimer scheduledTimerWithTimeInterval:2 target:self selector:@selector(getStepNumber) userInfo:nil repeats:YES];</div><div class="line">[[NSRunLoop currentRunLoop] addTimer:_timer forMode:NSDefaultRunLoopMode];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">- (void)getStepNumber</div><div class="line">&#123;</div><div class="line"></div><div class="line">lable.text = [NSString stringWithFormat:@&quot;我走了  %ld步&quot;,[StepManager sharedManager].step];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>另外还需要注意的一点是，因为我们要实时计步所以，当我们应用程序在后台的时候仍然需要计步，所以要做一些处理<br>AppDelegate.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (void)applicationDidEnterBackground:(UIApplication *)application &#123;</div><div class="line">//播放一段无声音乐,使其可以一直在后台进行计步  此方法为第三方 若要详细了解，请下载demo自行研究</div><div class="line">[[MMPDeepSleepPreventer sharedSingleton] startPreventSleep];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>至此，就先普及这么多吧。文中的说话方式和一些内容纯属娱乐，希望大家不要介意。我也是菜鸟，希望大神可以批评指正。因为这样才能进步。文中链接比较多。大家也可以收藏下本文，今后备不时之需。实时计步还算挺火的。</p>
<p><a href="https://github.com/JimmyLession/StepDemo.git" target="_blank" rel="external">对了 附上demo 链接</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-03-05</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"> <a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"> <a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"> <a href="http://twitter.com/home?status=,http://leijianmin.com/2017/03/05/iOS-实时计步功能的简单实现/,阿飞的小蝴蝶,iOS 实时计步功能的简单实现,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2017/03/04/hello-world/" title="Hello World" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>